<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#FFD54F"> 
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2910/2910795.png">

    <title>GajiPro v13.0 - Secure & Dark</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root { 
            --bg-color: #f4f4f0;
            --dot-color: #d0d0d0;
            
            --primary: #FFD54F; /* Kuning Pop */
            --accent: #4FC3F7;  /* Biru Langit */
            --danger: #FF8A80;  /* Merah Soft */
            --success: #AED581; /* Hijau Soft */
            --surface: #ffffff;
            --text-main: #000000;
            --border-color: #000000;
            
            --border: 3px solid var(--border-color);
            --shadow: 4px 4px 0px var(--border-color);
            --shadow-active: 2px 2px 0px var(--border-color);
            
            --header-h: 70px;
            --nav-h: 80px;
        }

        /* --- DARK MODE VARIABLES --- */
        body.dark-mode {
            --bg-color: #121212;
            --dot-color: #333333;
            --surface: #1E1E1E;
            --text-main: #ffffff;
            --border-color: #000000; /* Tetap hitam biar kontras kartun */
            --primary: #FFC107; /* Kuning lebih gelap */
            --success: #7CB342;
            --danger: #E57373;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            height: 100dvh; width: 100%; margin: 0; padding: 0; 
            background-color: var(--bg-color);
            background-image: radial-gradient(var(--dot-color) 2px, transparent 2px);
            background-size: 20px 20px;
            color: var(--text-main); 
            font-family: 'Fredoka', sans-serif;
            overflow: hidden; 
            transition: background-color 0.3s;
        }

        /* --- LAYOUT --- */
        .app-header {
            position: fixed; top: 0; left: 0; right: 0; height: var(--header-h);
            background: var(--primary);
            border-bottom: var(--border);
            display: flex; align-items: center; justify-content: space-between; 
            padding: 0 20px; z-index: 100;
        }
        .logo-text { font-weight: 700; font-size: 1.6rem; letter-spacing: 1px; color: #000; text-transform: uppercase; -webkit-text-stroke: 1px #fff;}

        .content-wrapper {
            position: fixed; top: var(--header-h); bottom: var(--nav-h); left: 0; right: 0; overflow: hidden;
        }
        .view-section { 
            height: 100%; width: 100%; overflow-y: auto; padding: 20px 20px 100px 20px; display: none; scroll-behavior: smooth;
        }
        .view-section.active { display: block; }

        /* --- COMPONENTS --- */
        .card { 
            background: var(--surface); border: var(--border); border-radius: 12px; 
            padding: 20px; margin-bottom: 20px; box-shadow: var(--shadow); position: relative;
            color: var(--text-main); transition: background 0.3s;
        }
        
        .card-title { font-size: 1rem; font-weight: 700; margin-bottom: 12px; text-transform: uppercase; display: flex; justify-content: space-between; align-items: center;}

        .input-group { margin-bottom: 16px; }
        .input-label { font-size: 0.85rem; font-weight: 600; margin-bottom: 6px; display: block;}
        
        input, select { 
            width: 100%; padding: 12px; 
            background: var(--surface); color: var(--text-main);
            border: var(--border); border-radius: 8px;
            font-family: 'Fredoka', sans-serif; font-size: 1.1rem; font-weight: 500;
            outline: none; transition: 0.1s;
        }
        /* Focus state fix for dark mode */
        input:focus, select:focus { transform: translate(-2px, -2px); box-shadow: 4px 4px 0 rgba(0,0,0,0.5); }

        .btn { 
            width: 100%; height: 50px; border: var(--border); border-radius: 10px;
            font-family: 'Fredoka', sans-serif; font-weight: 600; font-size: 1rem;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            box-shadow: var(--shadow); transform: translate(0, 0); transition: 0.1s;
            text-transform: uppercase; margin-bottom: 10px;
        }
        .btn:active { box-shadow: var(--shadow-active); transform: translate(2px, 2px); }
        
        .btn-primary { background: var(--accent); color: #000; }
        .btn-danger { background: var(--danger); color: #000; }
        .btn-secondary { background: var(--surface); color: var(--text-main); }
        .btn-success { background: var(--success); color: #000; }

        .btn-sm { height: 36px; font-size: 0.8rem; width: auto; padding: 0 15px; margin: 0; box-shadow: 2px 2px 0 #000;}
        .btn-sm:active { box-shadow: 0 0 0 #000; transform: translate(2px, 2px); }

        .stat-box { 
            background: var(--primary); border: var(--border); border-radius: 12px; 
            padding: 20px; margin-bottom: 20px; box-shadow: var(--shadow); text-align: center; color: #000;
        }
        .stat-val-big { font-size: 2.5rem; font-weight: 700; margin: 5px 0 15px 0; letter-spacing: -1px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        
        /* LOG LIST */
        .log-item { 
            background: var(--surface); border: var(--border); border-radius: 10px;
            padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 2px 2px 0 #000; transition: 0.1s; color: var(--text-main);
        }
        .log-item:active { transform: translate(1px, 1px); box-shadow: 1px 1px 0 #000; }

        .tag { padding: 4px 8px; border: 2px solid #000; border-radius: 6px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; margin-right: 5px; color: #000;}
        .tag-kerja { background: var(--success); }
        .tag-hutang { background: var(--primary); }
        .tag-kasbon { background: var(--danger); }

        /* NAV */
        .bottom-nav { 
            position: fixed; bottom: 0; left: 0; right: 0; height: var(--nav-h); 
            background: var(--surface); border-top: var(--border);
            display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; z-index: 200;
        }
        .nav-item { 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            cursor: pointer; transition: 0.2s; border-right: 1px solid #eee;
        }
        body.dark-mode .nav-item { border-right: 1px solid #333; }

        .nav-icon { width: 28px; height: 28px; fill: #ccc; margin-bottom: 4px; stroke: #000; stroke-width: 1px;}
        .nav-label { font-size: 0.75rem; font-weight: 700; color: #999; }

        .nav-item.active { background: #fff9c4; }
        body.dark-mode .nav-item.active { background: #444; } /* Dark Active Nav */
        
        .nav-item.active .nav-icon { fill: var(--primary); transform: scale(1.1); }
        .nav-item.active .nav-label { color: var(--text-main); }

        /* MODAL & PIN OVERLAY */
        .modal-overlay, .pin-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); backdrop-filter: blur(4px);
            z-index: 1000; display: none; align-items: center; justify-content: center; flex-direction: column;
        }
        .pin-overlay { z-index: 5000; background: var(--primary); } /* PIN di atas segalanya */

        .modal-content { 
            background: var(--surface); width: 90%; max-width: 350px; color: var(--text-main);
            border: var(--border); border-radius: 16px; 
            padding: 24px; box-shadow: 8px 8px 0 rgba(0,0,0,0.5); 
            animation: popUp 0.3s;
        }
        @keyframes popUp { 0% { transform: scale(0.5); } 100% { transform: scale(1); } }

        .checkbox-wrapper { display: flex; align-items: center; gap: 10px; margin-top: 5px; cursor: pointer; }
        .custom-check { width: 24px; height: 24px; border: var(--border); border-radius: 6px; display: flex; align-items: center; justify-content: center; background: #fff; }
        input[type="checkbox"]:checked + .custom-check { background: var(--primary); }
        
        .toast { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); background: #000; color: #fff; padding: 12px 24px; border-radius: 50px; font-weight: 600; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 3000; }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(10px); }
        
        /* PIN INPUT STYLES */
        .pin-display { display:flex; gap:10px; justify-content:center; margin-bottom:20px; }
        .pin-dot { width:20px; height:20px; border:2px solid #000; border-radius:50%; background:rgba(255,255,255,0.5); }
        .pin-dot.filled { background:#000; }
        .numpad { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:15px; width:280px; }
        .num-btn { 
            height:60px; border-radius:50%; border:2px solid #000; background:#fff; 
            font-size:1.5rem; font-weight:bold; display:flex; align-items:center; justify-content:center;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.2); cursor:pointer;
        }
        .num-btn:active { transform:translate(2px,2px); box-shadow:none; }
    </style>
</head>
<body>

    <div id="pin-lock" class="pin-overlay">
        <div style="font-size:3rem; margin-bottom:10px;">üîí</div>
        <h2 style="margin:0 0 20px 0; color:#000;">MASUKKAN PIN</h2>
        <div class="pin-display" id="pin-dots">
            <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
        </div>
        <div class="numpad" id="numpad">
            </div>
        <button onclick="forgotPin()" style="margin-top:30px; background:none; border:none; text-decoration:underline; font-weight:bold; cursor:pointer;">Lupa PIN?</button>
    </div>

    <div class="app-header">
        <div style="display: flex; align-items: center; gap: 10px;">
            <div style="width:36px; height:36px; background:#fff; border:2px solid #000; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#000; font-weight:bold;">GP</div>
            <span class="logo-text">GajiPro</span>
        </div>
        <button class="btn-sm btn-secondary" onclick="startPDFDownload()">PDF üñ®Ô∏è</button>
    </div>

    <div class="content-wrapper">
        
        <div id="view-home" class="view-section active">
            <div class="stat-box">
                <div>SISA BERSIH (NET)</div>
                <div class="stat-val-big" id="total-bersih">Rp 0</div>
                <div class="grid-2">
                    <div style="background:rgba(255,255,255,0.3); padding:8px; border-radius:8px; border:2px solid #000">
                        <small>PENDAPATAN</small><br><b id="txt-upah">0</b>
                    </div>
                    <div style="background:rgba(255,255,255,0.3); padding:8px; border-radius:8px; border:2px solid #000">
                        <small>POTONGAN</small><br><b id="txt-kasbon-home" style="color:#d32f2f">0</b>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">
                    <span>STATUS KEUANGAN</span>
                    <span id="lbl-status" style="font-size:0.8rem; background:#000; color:#fff; padding:2px 8px; border-radius:4px;">AMAN</span>
                </div>
                <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                    <span>Hutang Luar/Warung:</span>
                    <b style="color:var(--danger)" id="txt-hutang-home">Rp 0</b>
                </div>
                <div style="display:flex; justify-content:space-between; border-top:2px dashed #ccc; padding-top:8px;">
                    <span>Estimasi Akhir:</span>
                    <b style="font-size:1.2rem;" id="txt-sisa-akhir">Rp 0</b>
                </div>
            </div>

            <div class="card">
                <div class="card-title">üìù INPUT ABSENSI</div>
                <div class="input-group">
                    <label class="input-label">TANGGAL</label>
                    <input type="date" id="m-date">
                </div>
                <div class="grid-2">
                    <div class="input-group">
                        <label class="input-label">MASUK</label>
                        <input type="time" id="m-in" value="08:00">
                    </div>
                    <div class="input-group">
                        <label class="input-label">PULANG</label>
                        <input type="time" id="m-out" value="16:00">
                    </div>
                </div>
                <button class="btn btn-success" onclick="addManualWork()">‚úÖ MASUK KERJA</button>
            </div>
        </div>

        <div id="view-loans" class="view-section">
            <div class="stat-box" style="background:var(--danger);">
                <div style="color:#fff">TOTAL KEWAJIBAN</div>
                <div class="stat-val-big" style="color:#fff" id="total-kewajiban">Rp 0</div>
            </div>

            <div class="card">
                <div class="card-title">üè¢ KASBON KANTOR</div>
                <p style="margin:0 0 10px 0; font-size:0.9rem; opacity:0.7;">Potongan langsung dari gaji.</p>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; font-weight:bold;">
                    <span>Total Kasbon:</span>
                    <span id="txt-kasbon-loan">Rp 0</span>
                </div>
                <button class="btn btn-secondary" style="border-color:var(--danger); color:var(--danger)" onclick="openKasbonModal()">üí∏ AMBIL KASBON</button>
            </div>

            <div class="card">
                <div class="card-title">üè™ HUTANG WARUNG/LUAR</div>
                <p style="margin:0 0 10px 0; font-size:0.9rem; opacity:0.7;">Hutang makan/rokok (tidak potong gaji).</p>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; font-weight:bold;">
                    <span>Total Hutang:</span>
                    <span id="txt-hutang-loan">Rp 0</span>
                </div>
                <div class="grid-2">
                    <button class="btn btn-primary" onclick="openHutangModal()">‚ûï CATAT</button>
                    <button class="btn btn-success" onclick="openBayarModal()">üí∞ BAYAR</button>
                </div>
            </div>
        </div>

        <div id="view-history" class="view-section">
            <h2 style="margin-top:0">üóÇÔ∏è DATABASE</h2>
            
            <div class="card" style="padding:15px; background:var(--surface);">
                <div class="grid-2" style="margin-bottom:10px;">
                    <select id="filter-month" onchange="renderApp()">
                        <option value="all">SEMUA BULAN</option>
                    </select>
                    <select id="filter-type" onchange="renderApp()">
                        <option value="all">SEMUA TIPE</option>
                        <option value="KERJA">KERJA</option>
                        <option value="HUTANG">HUTANG</option>
                        <option value="KASBON">KASBON</option>
                    </select>
                </div>
                <div style="display:flex; gap:5px;">
                    <button class="btn-sm btn-secondary" onclick="setSort('new')">BARU</button>
                    <button class="btn-sm btn-secondary" onclick="setSort('high')">TERBESAR</button>
                    <button class="btn-sm btn-secondary" onclick="setSort('low')">TERKECIL</button>
                </div>
            </div>

            <div id="log-list"></div>
        </div>

        <div id="view-settings" class="view-section">
            <h2 style="margin-top:0">‚öôÔ∏è PENGATURAN</h2>

            <div class="card">
                <div class="card-title">TAMPILAN & KEAMANAN</div>
                
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #ccc; padding-bottom:10px;">
                    <span>üåô Mode Gelap</span>
                    <label class="checkbox-wrapper" style="margin:0;">
                        <input type="checkbox" id="chk-darkmode" onchange="toggleDarkMode(this)" style="display:none">
                        <div class="custom-check" style="border-radius:20px; width:40px;">üí°</div>
                    </label>
                </div>

                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span>üîí Kunci PIN</span>
                    <button class="btn-sm btn-primary" id="btn-set-pin" onclick="setupPin()">AKTIFKAN</button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">GAJI & LEMBUR</div>
                <div class="input-group">
                    <label class="input-label">GAJI POKOK (PER HARI)</label>
                    <input type="text" id="set-upah-tab" oninput="formatInputMoney(this)">
                </div>
                <div class="input-group">
                    <label class="input-label">RATE LEMBUR (PER JAM)</label>
                    <input type="text" id="set-lembur-tab" oninput="formatInputMoney(this)">
                </div>
                <button class="btn btn-primary" onclick="saveSettingsTab()">üíæ SIMPAN CONFIG</button>
            </div>

            <div class="card">
                <div class="card-title">BACKUP / RESTORE</div>
                <button class="btn btn-secondary" onclick="startExportData()">‚¨áÔ∏è DOWNLOAD DATA (.JSON)</button>
                <div style="height:10px;"></div>
                <button class="btn btn-secondary" onclick="triggerImport()">‚¨ÜÔ∏è RESTORE DATA</button>
                <input type="file" id="file-input" style="display:none" onchange="importData(this)">
            </div>

            <button class="btn btn-danger" onclick="hardReset()">‚ö†Ô∏è RESET PABRIK (HAPUS SEMUA)</button>
            <div style="text-align:center; margin-top:20px; font-size:0.8rem; opacity:0.6;">GAJIPRO V13.0 // SECURE EDITION</div>
        </div>

    </div> 

    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('home')" id="nav-home">
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
            <span class="nav-label">HOME</span>
        </div>
        <div class="nav-item" onclick="switchTab('loans')" id="nav-loans">
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></svg>
            <span class="nav-label">KEUANGAN</span>
        </div>
        <div class="nav-item" onclick="switchTab('history')" id="nav-history">
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
            <span class="nav-label">DATABASE</span>
        </div>
        <div class="nav-item" onclick="switchTab('settings')" id="nav-settings">
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
            <span class="nav-label">SETTING</span>
        </div>
    </div>

    <div id="modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-title" style="margin-top:0; border-bottom:2px solid #000; padding-bottom:10px;">JUDUL</h3>
            <div id="modal-body"></div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn btn-secondary" onclick="closeModal()">BATAL</button>
                <button class="btn btn-primary" id="modal-confirm">OKE</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">Notifikasi</div>

<script>
    // --- DATABASE & INIT ---
    let appConfig = JSON.parse(localStorage.getItem('gp_config')) || { UPAH: 130000, LEMBUR: 15000, DARK: false, PIN: null };
    let dbLogs = JSON.parse(localStorage.getItem('gp_v4')) || [];
    let currentSort = 'new'; 
    let tempPin = "";

    window.onload = function() {
        document.getElementById('m-date').value = new Date().toISOString().split('T')[0];
        
        // Init Dark Mode
        if(appConfig.DARK) {
            document.body.classList.add('dark-mode');
            document.getElementById('chk-darkmode').checked = true;
        }

        // Init PIN Lock
        if(appConfig.PIN) {
            showPinLock();
            document.getElementById('btn-set-pin').innerText = "GANTI PIN";
            document.getElementById('btn-set-pin').className = "btn-sm btn-danger";
        }

        renderApp();
    };

    // --- PIN LOGIC ---
    function showPinLock() {
        document.getElementById('pin-lock').style.display = 'flex';
        renderNumpad();
    }

    function renderNumpad() {
        const pad = document.getElementById('numpad');
        pad.innerHTML = '';
        [1,2,3,4,5,6,7,8,9,'C',0,'OK'].forEach(n => {
            const btn = document.createElement('div');
            btn.className = 'num-btn';
            btn.innerText = n;
            btn.onclick = () => handlePinInput(n);
            pad.appendChild(btn);
        });
        updatePinDots();
    }

    function handlePinInput(val) {
        if(val === 'C') { tempPin = ""; }
        else if(val === 'OK') { validatePin(); }
        else {
            if(tempPin.length < 4) tempPin += val;
            if(tempPin.length === 4) setTimeout(validatePin, 200);
        }
        updatePinDots();
    }

    function updatePinDots() {
        const dots = document.querySelectorAll('.pin-dot');
        dots.forEach((d, i) => {
            if(i < tempPin.length) d.classList.add('filled');
            else d.classList.remove('filled');
        });
    }

    function validatePin() {
        if(tempPin === appConfig.PIN) {
            document.getElementById('pin-lock').style.display = 'none';
            tempPin = "";
        } else {
            showToast("‚ùå PIN SALAH!");
            tempPin = "";
            updatePinDots();
        }
    }

    function setupPin() {
        if(appConfig.PIN) {
            // Hapus PIN
            openModal("HAPUS PIN", "Yakin ingin menghapus PIN keamanan?", () => {
                appConfig.PIN = null;
                saveData();
                showToast("PIN Dihapus");
                document.getElementById('btn-set-pin').innerText = "AKTIFKAN";
                document.getElementById('btn-set-pin').className = "btn-sm btn-primary";
            });
        } else {
            // Buat PIN Baru
            openModal("BUAT PIN BARU", 
                `<div class="input-group"><label class="input-label">Masukkan 4 Angka</label><input type="number" id="new-pin-inp" placeholder="1234" maxlength="4"></div>`, 
                () => {
                    const p = document.getElementById('new-pin-inp').value;
                    if(p.length === 4) {
                        appConfig.PIN = p;
                        saveData();
                        showToast("‚úÖ PIN Diaktifkan!");
                        document.getElementById('btn-set-pin').innerText = "GANTI PIN";
                        document.getElementById('btn-set-pin').className = "btn-sm btn-danger";
                    } else {
                        showToast("Harus 4 angka!");
                    }
                }
            );
        }
    }

    function forgotPin() {
        alert("Jika lupa PIN, satu-satunya cara adalah 'Clear Data' browser atau Install Ulang aplikasi. Data akan hilang demi keamanan.");
    }

    // --- DARK MODE LOGIC ---
    function toggleDarkMode(el) {
        if(el.checked) {
            document.body.classList.add('dark-mode');
            appConfig.DARK = true;
        } else {
            document.body.classList.remove('dark-mode');
            appConfig.DARK = false;
        }
        saveData();
    }

    // --- NAVIGATION ---
    function switchTab(tabId) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById(`view-${tabId}`).classList.add('active');
        document.getElementById(`nav-${tabId}`).classList.add('active');
        
        if(tabId === 'settings') {
            document.getElementById('set-upah-tab').value = formatMoneySimple(appConfig.UPAH);
            document.getElementById('set-lembur-tab').value = formatMoneySimple(appConfig.LEMBUR);
        }
    }

    // --- CORE LOGIC ---
    function addManualWork() {
        const d = document.getElementById('m-date').value;
        const tIn = document.getElementById('m-in').value; 
        const tOut = document.getElementById('m-out').value; 

        if(!d || !tIn || !tOut) return showToast("‚ö†Ô∏è Data belum lengkap!");

        const getHour = (t) => { const [h, m] = t.split(':').map(Number); return h + (m/60); };
        const inH = getHour(tIn);
        const outH = getHour(tOut);
        
        let pay = 0, note = "";
        
        if (outH <= 12.5) { 
            pay = appConfig.UPAH * 0.5; note = "Setengah Hari (Pagi)"; 
        } else if (inH >= 12.5) { 
            pay = appConfig.UPAH * 0.5; note = "Setengah Hari (Siang)"; 
        } else {
            pay = appConfig.UPAH; note = `Full Day (${tIn}-${tOut})`;
            const ot = Math.floor(outH - 16.0); 
            if (ot > 0) { 
                pay += ot * appConfig.LEMBUR; 
                note += ` + Lembur ${ot} Jam`; 
            }
        }

        dbLogs.unshift({ 
            id: Date.now(), 
            tgl: new Date(d).toLocaleDateString('id-ID'), 
            type: 'KERJA', 
            val: pay, 
            note: note 
        });
        
        saveData(); showToast("‚úÖ Absensi Tersimpan!");
    }

    // --- MODAL & INPUTS ---
    function openModal(title, html, callback) {
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-body').innerHTML = html;
        const btn = document.getElementById('modal-confirm');
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        newBtn.onclick = () => { callback(); closeModal(); };
        document.getElementById('modal').style.display = 'flex';
    }
    function closeModal() { document.getElementById('modal').style.display = 'none'; }

    function openKasbonModal() {
        openModal("AMBIL KASBON", 
            `<div class="input-group"><label class="input-label">Jumlah Kasbon</label><input type="number" id="inp-val" placeholder="Rp 0"></div>`,
            () => {
                const val = parseInt(document.getElementById('inp-val').value);
                if(val) {
                    dbLogs.unshift({ id: Date.now(), tgl: getDateStr(), type: 'KASBON', val: val, note: 'Kasbon Kantor' });
                    saveData(); showToast("Kasbon tercatat");
                }
            }
        );
    }

    function openHutangModal() {
        const html = `
            <div class="input-group">
                <label class="input-label">Tempat Hutang</label>
                <select id="inp-cat">
                    <option value="Warung Nasi">Warung Nasi</option>
                    <option value="Warung Biasa">Warung Biasa</option>
                    <option value="Lainnya">Lainnya</option>
                </select>
            </div>
            <div class="input-group">
                <label class="input-label">Nominal</label>
                <input type="number" id="inp-val" placeholder="Rp 0">
                <label class="checkbox-wrapper">
                    <input type="checkbox" id="chk-unknown" style="display:none" onchange="toggleDebtInput(this)">
                    <div class="custom-check">‚úîÔ∏è</div>
                    <span>Harga belum tau?</span>
                </label>
            </div>
        `;
        openModal("CATAT HUTANG", html, () => {
            const isUnknown = document.getElementById('chk-unknown').checked;
            const val = parseInt(document.getElementById('inp-val').value) || 0;
            const cat = document.getElementById('inp-cat').value;
            
            if(val > 0 || isUnknown) {
                dbLogs.unshift({ id: Date.now(), tgl: getDateStr(), type: 'HUTANG', val: val, note: cat, isPending: isUnknown });
                saveData(); showToast("Hutang tercatat");
            }
        });
    }

    function toggleDebtInput(cb) {
        const inp = document.getElementById('inp-val');
        if(cb.checked) { inp.value = 0; inp.disabled = true; inp.style.background = '#eee'; } 
        else { inp.disabled = false; inp.style.background = 'var(--surface)'; }
    }

    function openBayarModal() {
        openModal("BAYAR HUTANG", 
            `<div class="input-group"><label class="input-label">Jumlah Dibayar</label><input type="number" id="inp-val" placeholder="Rp 0"></div>`,
            () => {
                const val = parseInt(document.getElementById('inp-val').value);
                if(val) {
                    dbLogs.unshift({ id: Date.now(), tgl: getDateStr(), type: 'BAYAR_HUTANG', val: val, note: 'Bayar Hutang' });
                    saveData(); showToast("Pembayaran tercatat");
                }
            }
        );
    }

    function confirmDel(id) {
        openModal("HAPUS DATA?", "Yakin ingin menghapus data ini selamanya?", () => {
            dbLogs = dbLogs.filter(x => x.id !== id);
            saveData(); showToast("Data dihapus");
        });
    }

    function editItem(id) {
        const item = dbLogs.find(x => x.id === id);
        if(!item) return;
        let htmlVal = `<div class="input-group"><label class="input-label">Nominal</label><input type="number" id="e-val" value="${item.val}"></div>`;
        if(item.isPending) htmlVal = `<div class="input-group"><label class="input-label">Harga Sudah Tau?</label><input type="number" id="e-val" placeholder="Masukkan harga..."></div>`;
        const html = `${htmlVal}<div class="input-group"><label class="input-label">Catatan</label><input type="text" id="e-note" value="${item.note}"></div>`;
        
        openModal("EDIT DATA", html, () => {
            const newVal = parseInt(document.getElementById('e-val').value) || 0;
            item.val = newVal;
            item.note = document.getElementById('e-note').value;
            if(newVal > 0) item.isPending = false;
            saveData(); showToast("Data diupdate");
        });
    }

    // --- RENDER ---
    function setSort(type) { currentSort = type; renderApp(); }

    function renderApp() {
        const fMonth = document.getElementById('filter-month').value;
        const fType = document.getElementById('filter-type').value;

        let filtered = fMonth === 'all' ? dbLogs : dbLogs.filter(l => {
            const [d, m, y] = l.tgl.split('/'); return `${y}-${m}` === fMonth;
        });
        if(fType !== 'all') filtered = filtered.filter(l => l.type === fType);

        if(currentSort === 'new') filtered.sort((a,b) => b.id - a.id);
        else if(currentSort === 'high') filtered.sort((a,b) => b.val - a.val);
        else if(currentSort === 'low') filtered.sort((a,b) => a.val - b.val);

        const months = [...new Set(dbLogs.map(l => { const [d, m, y] = l.tgl.split('/'); return `${y}-${m}`; }))].sort().reverse();
        const sel = document.getElementById('filter-month');
        if(sel.options.length === 1 && months.length > 0) { 
            months.forEach(m => {
                const opt = document.createElement('option'); opt.value = m;
                const dateObj = new Date(m + "-01");
                opt.text = dateObj.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' }).toUpperCase();
                sel.add(opt);
            });
        }

        let html = "";
        filtered.forEach(item => {
            let tagClass = item.type === 'KERJA' ? 'tag-kerja' : (item.type === 'KASBON' ? 'tag-kasbon' : 'tag-hutang');
            if(item.type === 'BAYAR_HUTANG') tagClass = 'tag-kerja';

            let priceDisplay = item.isPending ? `<span style="color:var(--danger); font-weight:bold; animation:blink 1s infinite">HARGA ??</span>` : `Rp ${item.val.toLocaleString('id-ID')}`;
            
            html += `
            <div class="log-item" onclick="editItem(${item.id})">
                <div style="flex:1">
                    <div style="font-size:0.9rem; margin-bottom:4px;">
                        <span class="tag ${tagClass}">${item.type}</span> 
                        <span style="opacity:0.6; font-size:0.8rem">${item.tgl}</span>
                    </div>
                    <div style="font-weight:700;">${item.note}</div>
                </div>
                <div style="text-align:right">
                    <div style="font-size:1.1rem; font-weight:700; color:${item.type==='KASBON' || item.type==='HUTANG' ? 'var(--danger)' : 'var(--success)'}">${priceDisplay}</div>
                    <div style="color:#999; font-size:1.5rem; margin-top:5px;" onclick="confirmDel(${item.id}); event.stopPropagation()">√ó</div>
                </div>
            </div>`;
        });
        document.getElementById('log-list').innerHTML = html || `<div style="text-align:center; padding:30px; opacity:0.5; font-style:italic;">Belum ada data...</div>`;

        let totalKotor = 0, totalKasbon = 0, hutangIn = 0, hutangOut = 0;
        dbLogs.forEach(i => {
            if(i.type === 'KERJA') totalKotor += i.val;
            else if(i.type === 'KASBON') totalKasbon += i.val;
            else if(i.type === 'HUTANG') hutangIn += i.val;
            else if(i.type === 'BAYAR_HUTANG') hutangOut += i.val;
        });

        const sisaHutang = hutangIn - hutangOut;
        const bersih = totalKotor - totalKasbon;
        const sisaAkhir = bersih - sisaHutang;

        setText('txt-upah', formatMoney(totalKotor));
        setText('txt-kasbon-home', "- " + formatMoney(totalKasbon));
        setText('total-bersih', formatMoney(bersih));
        setText('txt-hutang-home', formatMoney(sisaHutang));
        setText('txt-sisa-akhir', formatMoney(sisaAkhir));
        setText('total-kewajiban', formatMoney(totalKasbon + sisaHutang));
        setText('txt-kasbon-loan', formatMoney(totalKasbon));
        setText('txt-hutang-loan', formatMoney(sisaHutang));

        const lbl = document.getElementById('lbl-status');
        if(sisaAkhir < 0) { lbl.innerText = "DEFISIT"; lbl.style.background = "var(--danger)"; }
        else { lbl.innerText = "AMAN"; lbl.style.background = "var(--success)"; }
    }

    // --- HELPERS ---
    function saveData() { 
        localStorage.setItem('gp_v4', JSON.stringify(dbLogs)); 
        localStorage.setItem('gp_config', JSON.stringify(appConfig));
        renderApp(); 
    }
    
    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg; t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2000);
    }
    
    function setText(id, val) { const el = document.getElementById(id); if(el) el.innerText = val; }
    function formatMoney(n) { return "Rp " + n.toLocaleString('id-ID'); }
    function getDateStr() { return new Date().toLocaleDateString('id-ID'); }
    function formatMoneySimple(num) { return "Rp " + (num ? num.toLocaleString('id-ID') : '0'); }
    function formatInputMoney(el) {
        let val = el.value.replace(/\D/g, '');
        if(!val) { el.value = ''; return; }
        el.value = "Rp " + parseInt(val).toLocaleString('id-ID');
    }
    
    function saveSettingsTab() {
        const u = parseInt(document.getElementById('set-upah-tab').value.replace(/\D/g, '')) || 0;
        const l = parseInt(document.getElementById('set-lembur-tab').value.replace(/\D/g, '')) || 0;
        appConfig.UPAH = u; appConfig.LEMBUR = l;
        saveData(); showToast("Pengaturan Disimpan");
    }

    function startExportData() {
        const blob = new Blob([JSON.stringify({logs: dbLogs, config: appConfig})], {type:"application/json"});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); 
        a.download = `GAJIPRO_DATA_${getDateStr().replace(/\//g,'-')}.json`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }
    
    function triggerImport() { document.getElementById('file-input').click(); }
    
    function importData(input) {
        const r = new FileReader();
        r.onload = e => {
            try {
                const d = JSON.parse(e.target.result);
                if(d.logs) dbLogs = d.logs;
                if(d.config) appConfig = d.config;
                saveData(); showToast("Data berhasil direstore!");
            } catch(err) { showToast("File rusak / salah format"); }
        };
        r.readAsText(input.files[0]);
    }

    function hardReset() {
        openModal("RESET TOTAL", "Hapus semua data & PIN? Aplikasi akan kembali seperti baru.", () => {
            dbLogs = [];
            appConfig = { UPAH: 130000, LEMBUR: 15000, DARK: false, PIN: null };
            saveData(); 
            location.reload(); // Reload agar reset bersih
        });
    }

    async function startPDFDownload() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(18); doc.text("LAPORAN GAJIPRO", 14, 20);
        doc.setFontSize(10); doc.text("Dicetak: " + getDateStr(), 14, 26);
        const body = dbLogs.map(i => [ i.tgl, i.type, i.note, i.isPending ? "TBA" : "Rp " + i.val.toLocaleString('id-ID') ]);
        doc.autoTable({ startY: 30, head: [['TANGGAL', 'TIPE', 'CATATAN', 'NOMINAL']], body: body, theme: 'grid', headStyles: { fillColor: [255, 213, 79], textColor: [0,0,0] } });
        doc.save(`Laporan_GajiPro.pdf`);
    }

    // --- PWA REGISTRATION ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js').then(reg => console.log('SW Registered')).catch(err => console.log('SW Fail', err));
        });
    }
</script>
</body>
</html>
